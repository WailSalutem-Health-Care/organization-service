name: Build & Deploy (OKD)

on:
  push:
    branches: [main]

env:
  APP_NAME: organization-service

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install oc
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/oc/latest/linux/oc.tar.gz
          tar -xzf oc.tar.gz
          sudo mv oc /usr/local/bin/oc
          oc version --client

      - name: Login to OpenShift
        run: |
          oc login "${{ secrets.OPENSHIFT_SERVER }}" \
            --token="${{ secrets.OPENSHIFT_TOKEN }}" \
            --insecure-skip-tls-verify=true
          oc project "${{ secrets.OPENSHIFT_NAMESPACE }}"

      - name: Detect changed paths
        id: changes
        run: |
          BASE_SHA="${{ github.event.before }}"
          HEAD_SHA="${{ github.sha }}"
          
          # Handle first push case
          if [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ]; then
            echo "First push detected, assuming all changed"
            echo "k8s_changed=true" >> $GITHUB_OUTPUT
            echo "code_changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          CHANGED="$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" || echo "")"
          echo "Changed files:"
          echo "$CHANGED"

          # Check if k8s manifests changed
          if echo "$CHANGED" | grep -qE '^k8s/'; then
            echo "k8s_changed=true" >> $GITHUB_OUTPUT
          else
            echo "k8s_changed=false" >> $GITHUB_OUTPUT
          fi

          # Check if code changed
          if echo "$CHANGED" | grep -qE '^(cmd/|internal/|Dockerfile|go\.mod|go\.sum|permissions\.yml)'; then
            echo "code_changed=true" >> $GITHUB_OUTPUT
          else
            echo "code_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Apply Kubernetes manifests (if changed)
        if: steps.changes.outputs.k8s_changed == 'true'
        run: |
          echo "Applying Kubernetes manifests..."
          oc apply -f k8s/config/
          oc apply -f k8s/base/

      - name: Create BuildConfig if not exists
        if: steps.changes.outputs.code_changed == 'true'
        run: |
          if ! oc get bc/${{ env.APP_NAME }} 2>/dev/null; then
            echo "Creating BuildConfig..."
            oc new-build --name=${{ env.APP_NAME }} \
              --binary \
              --strategy=docker \
              --to=${{ env.APP_NAME }}:latest
          else
            echo "BuildConfig already exists"
          fi

      - name: Trigger OpenShift build (if code changed)
        if: steps.changes.outputs.code_changed == 'true'
        run: |
          echo "ðŸ”¨ Building new image..."
          oc start-build ${{ env.APP_NAME }} \
            --from-dir=. \
            --follow \
            --wait

      - name: Tag image with commit SHA
        if: steps.changes.outputs.code_changed == 'true'
        run: |
          oc tag ${{ env.APP_NAME }}:latest ${{ env.APP_NAME }}:${{ github.sha }}
          echo "Image tagged: ${{ env.APP_NAME }}:${{ github.sha }}"

      - name: Rollout restart deployment
        if: steps.changes.outputs.code_changed == 'true' || steps.changes.outputs.k8s_changed == 'true'
        run: |
          echo "Rolling out deployment..."
          oc rollout restart deployment/${{ env.APP_NAME }}
          oc rollout status deployment/${{ env.APP_NAME }} --timeout=5m

      - name: Verify deployment
        run: |
          echo "=== Deployment Status ==="
          oc get deployment ${{ env.APP_NAME }}
          echo ""
          echo "=== Pods ==="
          oc get pods -l app=${{ env.APP_NAME }}
          echo ""
          echo "=== Service ==="
          oc get svc ${{ env.APP_NAME }}
          echo ""
          echo "=== Route ==="
          oc get route ${{ env.APP_NAME }}

      - name: Get application URL
        run: |
          APP_URL=$(oc get route ${{ env.APP_NAME }} -o jsonpath='{.spec.host}')
          echo "Application deployed at: https://$APP_URL"